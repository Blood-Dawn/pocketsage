{% extends 'base.html' %}
{% block title %}Upload Portfolio CSV · PocketSage{% endblock %}
{% block content %}
  <section class="surface-card upload-card">
    <header class="upload-header">
      <h1>Upload positions</h1>
      <p>Import a CSV file featuring your latest holdings. Existing positions will be replaced.</p>
    </header>

    <form
      method="post"
      action="{{ url_for('portfolio.import_portfolio') }}"
      enctype="multipart/form-data"
      data-portfolio-upload
      data-redirect="{{ url_for('portfolio.list_portfolio') }}"
      aria-label="Upload portfolio CSV"
    >
      <input type="hidden" name="mapping" data-mapping-input>
      <div class="upload-input">
        <label class="file-picker">
          <span class="file-picker-label" data-file-label>Choose a CSV file</span>
          <input type="file" name="file" accept=".csv,text/csv" required>
        </label>
        <p class="upload-hint">Accepted columns: <code>symbol</code>, <code>quantity</code>, <code>avg_price</code>. Extra columns are ignored.</p>
      </div>
      <p class="upload-progress" data-upload-progress hidden>Waiting for file…</p>
      <section class="upload-preview" data-upload-preview hidden>
        <h2>Preview import</h2>
        <p class="upload-preview-summary" data-preview-summary>Review detected mappings before importing.</p>
        <div class="preview-mapping" data-mapping-table></div>
        <div class="preview-samples" data-sample-table></div>
        <div class="upload-preview-actions">
          <button type="button" class="btn-primary" data-confirm-import disabled hidden>Import holdings</button>
        </div>
      </section>
      <div class="upload-actions">
        <button type="submit" class="btn-primary">Preview import</button>
        <a class="btn-secondary" href="{{ url_for('portfolio.list_portfolio') }}">Back to portfolio</a>
      </div>
      <noscript>
        <p class="empty">JavaScript is disabled &mdash; the page will refresh while uploading.</p>
      </noscript>
    </form>
  </section>

  <section class="surface-card upload-guidance" aria-label="CSV format guidance">
    <h2>CSV format checklist</h2>
    <ul>
      <li>Each row represents a holding with a <strong>symbol</strong>, numeric <strong>quantity</strong>, and <strong>average price</strong>.</li>
  <li>Quantities support fractional shares (e.g. <code>0.125</code>).</li>
  <li>Include <code>account_id</code> (existing account) or <code>account</code> (new name) to attribute holdings; add <code>currency</code> for non-USD accounts.</li>
      <li>Prices should use a dot as the decimal separator. Currency should match the rest of your ledger.</li>
      <li>Duplicate symbols are merged by summing quantity and recomputing the weighted average price.</li>
      <li>You can download a fresh export from the portfolio overview at any time.</li>
    </ul>
  </section>
{% endblock %}
